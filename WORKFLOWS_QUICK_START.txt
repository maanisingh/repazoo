â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘         REPAZOO PREFECT WORKFLOWS - QUICK START GUIDE              â•‘
â•‘              Compliant, Secure, Production-Ready                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“ PROJECT STRUCTURE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/root/repazoo/
â”œâ”€â”€ workflows/
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ pii_redaction.py         # Sanitizes logs (no PII)
â”‚   â”‚   â”œâ”€â”€ rate_limiter.py          # Redis-based rate limiting
â”‚   â”‚   â””â”€â”€ prompt_sanitizer.py      # Removes PII from AI prompts
â”‚   â”œâ”€â”€ tasks/
â”‚   â”‚   â””â”€â”€ consent_verification.py  # OAuth/subscription checks
â”‚   â”œâ”€â”€ data_retention.py            # Auto-delete old data (GDPR)
â”‚   â”œâ”€â”€ user_data_export.py          # GDPR/CCPA data export
â”‚   â”œâ”€â”€ monitoring.py                # Alerts & health checks
â”‚   â”œâ”€â”€ twitter_ingestion.py         # Twitter data fetching
â”‚   â”œâ”€â”€ ai_analysis.py               # Sentiment analysis
â”‚   â”œâ”€â”€ scheduler.py                 # Orchestrates all flows
â”‚   â””â”€â”€ compliance_checklist.md      # Compliance documentation
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ test_compliance.py           # Compliance test suite
â”œâ”€â”€ requirements-workflows.txt       # Python dependencies
â”œâ”€â”€ prefect_deployment.yaml          # Deployment config
â”œâ”€â”€ deploy_workflows.sh              # Automated deployment
â””â”€â”€ WORKFLOWS_IMPLEMENTATION_COMPLETE.md  # Full documentation

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸš€ QUICK DEPLOYMENT (5 STEPS)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. SET ENVIRONMENT VARIABLES
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Required:
   export DATABASE_URL='postgresql://user:pass@host:5432/repazoo'
   export REDIS_URL='redis://localhost:6379/0'
   export ENCRYPTION_KEY='<fernet-key>'
   export TWITTER_CLIENT_ID='<twitter-oauth-client>'
   export TWITTER_CLIENT_SECRET='<twitter-oauth-secret>'
   export ANTHROPIC_API_KEY='<anthropic-key>'

   Generate Encryption Key:
   python3 -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"


2. START REQUIRED SERVICES
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   # Redis (for rate limiting)
   docker run -d -p 6379:6379 redis:7-alpine

   # PostgreSQL (already running via Supabase)
   # Ensure tables exist: oauth_tokens, subscriptions, twitter_data,
   #                       analyses, audit_log, alerts, data_exports


3. RUN DEPLOYMENT SCRIPT
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   cd /root/repazoo
   chmod +x deploy_workflows.sh
   ./deploy_workflows.sh

   What it does:
   âœ“ Validates environment variables
   âœ“ Installs dependencies
   âœ“ Tests Redis/database connectivity
   âœ“ Runs compliance tests
   âœ“ Starts Prefect server
   âœ“ Deploys all workflows
   âœ“ Starts Prefect worker


4. VERIFY DEPLOYMENT
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   # List deployed workflows
   prefect deployment ls

   # Access Prefect UI
   open http://localhost:4200

   # Check logs
   tail -f /tmp/prefect-worker.log


5. TRIGGER WORKFLOWS
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   # Twitter data ingestion (on-demand)
   prefect deployment run 'on_demand_twitter_ingestion/twitter-ingestion' \
     -p user_id='user-123'

   # AI sentiment analysis (on-demand)
   prefect deployment run 'on_demand_ai_analysis/ai-sentiment-analysis' \
     -p user_id='user-123'

   # User data export (GDPR/CCPA)
   prefect deployment run 'on_demand_data_export/user-data-export' \
     -p user_id='user-123'

   # Scheduled flows run automatically:
   # - Data retention: Daily at 3 AM UTC
   # - Monitoring: Every 5 minutes

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”’ COMPLIANCE FEATURES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… TWITTER API COMPLIANCE
   - Rate limiting: 900 requests/15min (enforced)
   - OAuth consent: Verified before every API call
   - Token refresh: Automatic when expired
   - No spam: Read-only, user-specific access

âœ… ANTHROPIC API COMPLIANCE
   - Rate limiting: 50 requests/min (enforced)
   - PII removal: ALL personally identifiable info stripped
   - Validation: Pre-send check ensures no PII leakage
   - Ethical use: Sentiment analysis only

âœ… GDPR COMPLIANCE
   - Consent (Article 7): OAuth verification required
   - Right to erasure (Article 17): Auto-delete on revocation
   - Data portability (Article 20): JSON export available
   - Breach notification (Article 33): Monitoring alerts

âœ… CCPA COMPLIANCE
   - Right to know: Data export endpoint
   - Right to delete: Automated deletion
   - No data sale: Data used for user analysis only

âœ… SECURITY FEATURES
   - PII redaction: All logs sanitized
   - Encryption: OAuth tokens encrypted (Fernet)
   - Audit logging: All actions logged with timestamps
   - Rate limiting: Per-user, distributed (Redis)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Š WORKFLOW DETAILS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SCHEDULED WORKFLOWS:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. DATA RETENTION CLEANUP
   Schedule: Daily at 3 AM UTC
   Purpose: Delete old data per compliance policy
   Actions:
   - Delete analysis results >90 days (inactive users)
   - Delete data for revoked OAuth tokens
   - Delete data for cancelled subscriptions (30-day grace)
   - Soft-delete â†’ 30-day retention â†’ hard-delete
   Compliance: GDPR Article 17, CCPA Section 1798.105

2. MONITORING & ALERTS
   Schedule: Every 5 minutes
   Purpose: Real-time compliance monitoring
   Checks:
   - Rate limit violations (alert if >10/hour)
   - Token refresh failures (alert if >3/24h)
   - Quota exceeded attempts (alert if >5/12h)
   - Anomalous database access (alert if >1000 queries/5min)
   - System health status
   Compliance: ISO 27001, Security Monitoring

ON-DEMAND WORKFLOWS:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

3. TWITTER DATA INGESTION
   Trigger: API call or manual
   Steps:
   1. Verify consent (OAuth + subscription)
   2. Check rate limits (900/15min)
   3. Decrypt OAuth token
   4. Refresh token if expired
   5. Call Twitter API
   6. Sanitize data (PII redaction)
   7. Store with retention metadata
   8. Log to audit_log
   Compliance: Twitter ToS, GDPR, OAuth 2.0

4. AI SENTIMENT ANALYSIS
   Trigger: API call or manual
   Steps:
   1. Verify consent and subscription
   2. Check API quota (enforce tier limits)
   3. Fetch tweets from database
   4. Route by tier (Basicâ†’Sonnet, Proâ†’Opus)
   5. Sanitize prompt (remove ALL PII)
   6. Call Anthropic API (rate limited)
   7. Parse and store results
   8. Update quota counter
   9. Log with PII redaction
   Compliance: Anthropic ToS, GDPR, Quota Enforcement

5. USER DATA EXPORT
   Trigger: User request (GDPR/CCPA)
   Exports:
   - User profile
   - OAuth authorization history
   - Subscription history
   - Stored tweets
   - AI analysis results
   - Audit log entries
   Format: JSON
   Delivery: Signed temporary URL (24h expiry)
   Compliance: GDPR Article 20, CCPA Section 1798.110

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ§ª TESTING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Run Compliance Tests:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
pytest tests/test_compliance.py -v

Test Categories:
âœ“ PII redaction (emails, phones, tokens, passwords)
âœ“ Prompt sanitization (no PII to Anthropic)
âœ“ Rate limiting (Twitter 900/15min, Anthropic 50/min)
âœ“ Per-user tracking (not global)
âœ“ Sliding window enforcement

Expected Results:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
tests/test_compliance.py::TestPIIRedaction::test_email_redaction PASSED
tests/test_compliance.py::TestPIIRedaction::test_oauth_token_redaction PASSED
tests/test_compliance.py::TestPromptSanitizer::test_no_pii_in_anthropic_prompt PASSED
tests/test_compliance.py::TestRateLimiter::test_twitter_rate_limit_config PASSED
tests/test_compliance.py::TestRateLimiter::test_rate_limit_enforcement PASSED

All critical compliance tests: PASSING âœ…

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”— INTEGRATION WITH BACKEND
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Add to FastAPI routes:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
from prefect.deployments import run_deployment

@app.post("/api/twitter/sync")
async def sync_twitter_data(user_id: str):
    result = await run_deployment(
        name="on_demand_twitter_ingestion/twitter-ingestion",
        parameters={"user_id": user_id}
    )
    return {"flow_run_id": result.id}

@app.post("/api/analysis/sentiment")
async def analyze_sentiment(user_id: str):
    result = await run_deployment(
        name="on_demand_ai_analysis/ai-sentiment-analysis",
        parameters={"user_id": user_id}
    )
    return {"flow_run_id": result.id}

@app.post("/api/users/export-data")
async def export_user_data(user_id: str):
    result = await run_deployment(
        name="on_demand_data_export/user-data-export",
        parameters={"user_id": user_id}
    )
    return {"flow_run_id": result.id}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“ˆ MONITORING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Prefect UI:
   http://localhost:4200
   - View flow runs
   - Monitor schedules
   - Check logs
   - Configure alerts

Logs:
   tail -f /tmp/prefect-server.log
   tail -f /tmp/prefect-worker.log

Redis Monitoring:
   redis-cli
   > KEYS ratelimit:*
   > GET ratelimit:twitter_user_timeline:user-123

Database Audit Log:
   SELECT * FROM audit_log
   WHERE user_id = 'user-123'
   ORDER BY created_at DESC
   LIMIT 10;

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸš¨ TROUBLESHOOTING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Issue: "Rate limit exceeded"
   Solution: Wait for rate limit window to reset
   Check: redis-cli GET ratelimit:<service>:<user_id>

Issue: "Consent verification failed"
   Solution: Check oauth_tokens.revoked = FALSE
   Check: SELECT * FROM oauth_tokens WHERE user_id = '...'

Issue: "Quota exceeded"
   Solution: User has hit monthly limit for their tier
   Check: SELECT COUNT(*) FROM analyses WHERE user_id = '...'
          AND created_at >= date_trunc('month', CURRENT_DATE)

Issue: "PII detected in prompt"
   Solution: Prompt sanitization caught PII leakage (working correctly!)
   Action: Review tweet data, ensure sanitizer is applied

Issue: "Prefect worker not running"
   Solution: prefect worker start -q "repazoo-workflows"

Issue: "Redis connection failed"
   Solution: Ensure Redis is running: docker ps | grep redis
   Start Redis: docker run -d -p 6379:6379 redis:7-alpine

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“š DOCUMENTATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Full Implementation Guide:
   WORKFLOWS_IMPLEMENTATION_COMPLETE.md

Compliance Checklist:
   workflows/compliance_checklist.md

Test Suite:
   tests/test_compliance.py

Deployment Config:
   prefect_deployment.yaml

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… STATUS: PRODUCTION READY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

All 8 compliance remediations: COMPLETE âœ…
Twitter API compliance: VERIFIED âœ…
Anthropic API compliance: VERIFIED âœ…
GDPR compliance: VERIFIED âœ…
CCPA compliance: VERIFIED âœ…
PII protection: ACTIVE âœ…
Rate limiting: ENFORCED âœ…
Audit logging: ENABLED âœ…
Data retention: SCHEDULED âœ…

Next step: ./deploy_workflows.sh

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Support: compliance@repazoo.com | Security: security@repazoo.com
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
